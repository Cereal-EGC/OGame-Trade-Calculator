// ==UserScript==
// @name           OGame Trade Calculator
// @description    Adds a trade calculator to the OGame interface
// @namespace      http://userscripts.org/users/68563/scripts
// @downloadURL    https://userscripts.org/scripts/source/151002.user.js
// @updateURL      https://userscripts.org/scripts/source/151002.meta.js
// @version        2.2.0
// @include        *://*.ogame.*/game/index.php?*page=*
// ==/UserScript==
/*! OGame Trade Calculator (C) 2012 Elías Grande Cásedas | GNU-GPL | gnu.org/licenses */
(function(){var y,p={ID_PREFIX:(y="o_trade_calc_"),NAME:"OGame Trade Calculator",HOME_URL:"http://userscripts.org/scripts/show/151002",TESTED_OGAME_VERSION:"5.2.0-beta1"};var k=window,C,l;try{if(unsafeWindow){k=unsafeWindow}}catch(z){}C=k.document;l=k.jQuery;l.getScript("/cdn/js/greasemonkey/version-check.js",function(){k.oGameVersionCheck(p.NAME,p.TESTED_OGAME_VERSION,p.HOME_URL)});
/*! jCaret (C) 2010 C. F. Wong | cloudgen.w0ng.hk | www.opensource.org/licenses/mit-license.php */
(function(E,e,D,F){E.fn.caret=function(U,Q){var H,K,S=this[0],M=E.browser.msie;if(typeof U==="object"&&typeof U.start==="number"&&typeof U.end==="number"){H=U.start;K=U.end}else{if(typeof U==="number"&&typeof Q==="number"){H=U;K=Q}else{if(typeof U==="string"){if((H=S.value.indexOf(U))>-1){K=H+U[e]}else{H=null}}else{if(Object.prototype.toString.call(U)==="[object RegExp]"){var R=U.exec(S.value);if(R!=null){H=R.index;K=H+R[0][e]}}}}}if(typeof H!="undefined"){if(M){var N=this[0].createTextRange();N.collapse(true);N.moveStart("character",H);N.moveEnd("character",K-H);N.select()}else{this[0].selectionStart=H;this[0].selectionEnd=K}this[0].focus();return this}else{if(M){var P=document.selection;if(this[0].tagName.toLowerCase()!="textarea"){var I=this.val(),L=P[D]()[F]();L.moveEnd("character",I[e]);var T=(L.text==""?I[e]:I.lastIndexOf(L.text));L=P[D]()[F]();L.moveStart("character",-I[e]);var O=L.text[e]}else{var L=P[D](),G=L[F]();G.moveToElementText(this[0]);G.setEndPoint("EndToEnd",L);var T=G.text[e]-L.text[e],O=T+L.text[e]}}else{var T=S.selectionStart,O=S.selectionEnd}var J=S.value.substring(T,O);return{start:T,end:O,text:J,replace:function(V){return S.value.substring(0,T)+V+S.value.substring(O,S.value[e])}}}}})(l,"length","createRange","duplicate");
/*! [/jCaret] */
String.prototype.replaceAll=function(e,D){return this.split(e).join(D)};String.prototype.recursiveReplaceMap=function(G,F,D){if(D==0){return this.split(G[0]).join(F[0])}var E,e=this.split(G[D]);for(E in e){e[E]=e[E].recursiveReplaceMap(G,F,D-1)}return e.join(F[D])};String.prototype.replaceMap=function(e){var D,G,F,E;G=new Array();F=new Array();E=0;for(D in e){G.push(D);F.push(e[D]);E++}if(E==0){return this}else{return this.recursiveReplaceMap(G,F,E-1)}};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")};var g=({getMeta:function(D,E){try{return l('meta[name="'+D+'"]').attr("content")}catch(F){if(arguments.length>1){return E}else{return null}}},getResource:function(E){var e={NAME:"",AMOUNT:0,getName:function(G){var F=this.NAME+"";g[G]=this.AMOUNT+0;return F}};var D=l("#"+E).attr("title");e.NAME=D.split(":").shift();e.AMOUNT=parseInt(D.split("/tr").shift().replace(/\D/g,""));return e},init:function(){return{LANGUAGE:this.getMeta("ogame-language",""),RES_MET:this.getResource("metal_box"),RES_CRY:this.getResource("crystal_box"),RES_DEU:this.getResource("deuterium_box")}}}).init();var n={
/*! [colors] */
MET:"#FF7700",CRY:"#00FFFF",DEU:"#FF33FF"
/*! [/colors] */
};var o=({text:{RES_MET:g.RES_MET.getName("RES_MET"),RES_CRY:g.RES_CRY.getName("RES_CRY"),RES_DEU:g.RES_DEU.getName("RES_DEU")},set:function(e,D){if(e.test(g.LANGUAGE)){l.extend(true,this.text,D)}return this}}
/*! [i18n=en] */
).set(/.*/,{THO_SEP:",",DEC_SEP:".",MENU:"Trace C.",TITLE:"Trade calculator",ACTION:"Action",BUY:"I buy",SELL:"I sell",RATIO:"Ratio",ILLEGAL:"illegal",IN_EXCH:"In exchange for",RESULT:"Result",MESSAGE:"Message",WHERE:"Place of delivery",PLANET:"Planet",MOON:"Moon",CUR_PLA:"Current planet",MAX:"Maximum",REG:"Regular",MIN:"Minimum",RAT_LST:"Ratio list",NAME:"Name",LEGAL:"Legal",YES:"Yes",NO:"No",DEFAULT:"Default",NEW:"New",ACCEPT:"Accept",CANCEL:"Cancel",RES_DEF:"Restore default settings"}
/*! [i18n=es] */
).set(/es|ar|mx/,{THO_SEP:".",DEC_SEP:",",MENU:"C. Comercio",TITLE:"Calculadora de comercio",ACTION:"Acción",BUY:"Compro",SELL:"Vendo",RATIO:"Ratio",ILLEGAL:"ilegal",IN_EXCH:"A cambio de",RESULT:"Resultado",MESSAGE:"Mensaje",WHERE:"Lugar de entrega",PLANET:"Planeta",MOON:"Luna",CUR_PLA:"Planeta actual",MAX:"Máximo",REG:"Normal",MIN:"Mínimo",RAT_LST:"Lista de ratios",NAME:"Nombre",LEGAL:"Legal",YES:"Si",NO:"No",DEFAULT:"Por defecto",NEW:"Nuevo",ACCEPT:"Aceptar",CANCEL:"Cancelar",RES_DEF:"Restaurar ajustes por defecto"}
/*! [/i18n] */
).text;var f={
/*! [css] */
CSS:"#"+y+"window{float:left;position:relative;width:670px;overflow:visible;z-index:2;}#galaxy #"+y+"window{top:-44px;}#"+y+'header{height:28px;position: relative;background: url("http://gf1.geo.gfsrv.net/cdn63/10e31cd5234445e4084558ea3506ea.gif") no-repeat scroll 0px 0px transparent;}#'+y+"header h4{height:28px;line-height:28px;text-align:center;color:#6F9FC8;font-size:12px;font-weight:bold;position:absolute;top:0;left:100px;right:100px;}#"+y+"config_but{display:block;height:16px;width:16px;background:url(http://gf3.geo.gfsrv.net/cdne7/1f57d944fff38ee51d49c027f574ef.gif);float:right;margin:8px 0 0 0;opacity:0.5;}#"+y+"config_but:hover{opacity:1;}#"+y+'window.config input[type="button"]{margin:0 5px 0 5px;}#'+y+"window.config #"+y+"config_but{display:none;}#"+y+"config,#"+y+"window.config #"+y+"calc{display:none;}#"+y+"window.config #"+y+"config{display:block;}#"+y+'main{padding:15px 25px 0 25px;background: url("http://gf1.geo.gfsrv.net/cdn9e/4f73643e86a952be4aed7fdd61805a.gif") repeat-y scroll 5px 0px transparent;}#'+y+"main *{font-size:11px;}#"+y+"window table{width:620px;background-color:#0D1014;border-collapse:collapse;clear:both;}#"+y+"window.config table{width:598px;}#"+y+"main th{color:#6F9FC8;text-align:center;font-weight:bold;}."+y+"label,."+y+"label *{color:grey;text-align:left;}."+y+"label{padding:0 5px 0 5px;font-weight:bold;}#"+y+"window.config ."+y+"label{text-align:center;}#"+y+"main tr,#"+y+"main td,#"+y+"main th{height:28px;line-height:28px;}#"+y+'main input[type="text"]{width:100px;text-align:center;}option.'+y+"highlight{color:lime !important;font-weight:bold;}option."+y+"moon{color:orange;}."+y+"select{width:150px;text-align:left;}."+y+"select select{width:130px;text-align:center;}#"+y+"main option{padding:1px 5px 1px 5px;}."+y+"input{width:112px;padding:0 1px 0 1px;text-align:right;}."+y+"name{width:142px;padding:0 1px 0 1px;text-align:right;}#"+y+"main ."+y+"name input{width:130px;text-align:center;}."+y+"ratio{width:82px;padding:0 1px 0 1px;text-align:right;}#"+y+"main ."+y+"ratio input{width:70px;text-align:center;}#"+y+"ratio_illegal{color:red;}."+y+"output{width:108px;text-align:center;font-weight:bold;}#"+y+"output_met{color:"+n.MET+";}#"+y+"output_cry{color:"+n.CRY+";}#"+y+"output_deu{color:"+n.DEU+";}."+y+"textarea{padding:0 3px 0 3px !important;}#"+y+"message{width:601px;height:50px !important;margin:0 !important;}#"+y+"planet{width:auto;text-align:left;margin:0;}."+y+"select1row select{width:auto;text-align:left;margin:0;}#"+y+'footer{height:17px;background: url("http://gf1.geo.gfsrv.net/cdn30/aa3e8edec0a2681915b3c9c6795e6f.gif") no-repeat scroll 2px 0px transparent;}.'+y+'config_title{font-size:11px;font-weight:bold;color:#6F9FC8;line-height:22px;background:url("http://gf1.geo.gfsrv.net/cdn0b/d55059f8c9bab5ebf9e8a3563f26d1.gif") no-repeat scroll 0 0 #13181D;height:22px;margin:0 0 10px 0;padding:0 0 0 40px;border:1px solid #000;overflow:hidden;cursor:pointer;}.'+y+"config_title:hover{color:#A7AFB7;background-color:#23282D;border-color:#13181D;}."+y+"config_box{border:1px solid #000;margin:5px 5px 10px 5px;padding:5px;}#"+y+"new_ratio input{border-color:#9C0;}."+y+"check,."+y+"name_noedit{text-align:center;}."+y+"check input{vertical-align:text-bottom;}."+y+'check input[type="checkbox"]{vertical-align:middle;}.'+y+"action{text-align:center;padding:0 3px 0 3px;}."+y+'action a{background:url("http://gf1.geo.gfsrv.net/cdn94/297ee218d94064df0a66bd41a04d28.png") scroll 0 0 no-repeat;width:16px;height:16px;display:inline-block;vertical-align:top;position:relative;top:5px;border:1px solid #000;border-radius:2px;opacity:0.7;}a.'+y+"icon_up,a."+y+"icon_down,a."+y+"icon_add{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAwCAMAAAAvgQplAAAAAXNSR0IArs4c6QAAAvpQTFRFbomeXHaLb4mdgpyveJaxdpSweZKk////W3qXVnKNRWB6AAAANTU1PT09MUJTJzVD/6gAzAAA/9IA/wAAqsrjvtjrna25PlVsTWiCqbjESGF6YHyaOk9ldZOwTWeCPj4+PlRsVHeYRGKBUXCRQVx6VnibTGmFVnmbRWOERWSEXn+chJusPVhzU3SVQ19+TGyKU3aXPVRrTGqHkrHKPVZwUW6KQ2GAU3aZO09lcJCqYHqORV95UW6LTGeBQFlySGB5SmF6Q2B+VnmaUG2JVnSQS2qHSmeCL0RaXHmUU3WVoLzSqcTYQ2GCPFZxPVZxkaa1RWSDPFZyRl96XH2ZTGqGS2qJO1Ru1d7lV3SROk5kQVp0QVpz5erua4OWqLnGpcDUWn2ewMzVlK/EqLbCcY+qj6zESmF3r7zHob3TTGaAlqi2haO9XniNQ115TWiD8vX4k7DGZ4mqyNTdSmaBpcHWcImdjaKynbrRdY6hvMnTSWeHYXyaq7jDV3SQ6+/zo7/Ur8rd8PP1javGhaK82uLmq8bZq7vHh6a+0NrgnLjOhJqqUG+QpL/VsL7JdJOuXnmSytTcj6OxT2qE+Pn7eZm0zCszfZmxhqXBdZGpXHaOS2uKboynr73J4ebrhKO7obLAmLfR+vv9nLfNip+uX3yYXn+bdoyec42gobC9pbS/yNPbYX2aPVRtt8XPmLTLbo2odI2geI2fVHKT2OHo3OLoRGGBRmODkK7HaImkaomka4unjaCw/f7/mbjRXnyXd4+jf5Wmp8HWjq3IiqnEeZOqPlVtVHeXYH2ai6CxYYCbZIKfZn+TTGeDVnWQb5GtVnWRSWWASmWATGuKc5CpusXOU3GQlLPMXHqXUnSUZoSifJq0fJu3ZHyT/v//dpOwqcXZYHqSYnuQ7fDz7PD0XHyYWnaRkKW1TGiFTGmEj6zDYXuPPFdzPVdzrsndhpytVHaYh52uXn6c8PP2jqzFQFt5jKvFcYqeQl99gZ+52uHmRGKAyNTcV3iaqsbZDVW+rgAAAAF0Uk5TAEDm2GYAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3AsJFTcNV6u1fQAAAE9JREFUKM/dkjEOACAIA6tL//9jFaORqhtxsBO9CS4AyQXSKwkEpAfkIMgttNh4AUtCALQ/9NGPu4A87/erj/6DD30HBZuPwztsPmIFqY8CjdEFo21taJsAAAAASUVORK5CYII=);}a."+y+"icon_down{background-position:0px -16px}a."+y+"icon_add{background-position:0px -32px}."+y+"action a:hover{opacity:1;border-color:#08090b;}."+y+"action a.disabled,."+y+"action aldisabled:hover{opacity:0.1;cursor:default;}a."+y+"icon_trash{background-position:0px -304px}#"+y+"window.config .undermark,#"+y+"window.config .overmark{font-weight:bold;text-align:center;}#"+y+"ie_conf{display:block;width:586px;margin:0 0 5px 0;}."+y+"ie_conf{text-align:center}",
/*! [tpl=window] */
WINDOW:'<div id="'+y+'window" class="calc"><div id="'+y+'header"><h4>'+o.TITLE+'</h4><a id="'+y+'close" href="javascript:void(0);" class="close_details close_ressources"></a><a id="'+y+'config_but" href="javascript:void(0);"></a></div><div id="'+y+'main"><div id="'+y+'calc"><table cellspacing="0" cellpadding="0"><tbody><tr><th colspan="2"></th><th>'+o.RES_MET+"</th><th>"+o.RES_CRY+"</th><th>"+o.RES_DEU+'</th></tr><tr class="alt"><td class="'+y+'label">'+o.ACTION+'</td><td class="'+y+'select"><select id="'+y+'action"><option value="sell">'+o.SELL+'</option><option value="buy">'+o.BUY+'</option></select></td><td class="'+y+'input"><input id="'+y+'input_met" type="text" value=""></td><td class="'+y+'input"><input id="'+y+'input_cry" type="text" value=""></td><td class="'+y+'input"><input id="'+y+'input_deu" type="text" value=""></td></tr><tr><td class="'+y+'label">'+o.RATIO+'<span id="'+y+'ratio_illegal"> ('+o.ILLEGAL+')</span></td><td class="'+y+'select"><select id="'+y+'ratio"></select></td><td class="'+y+'input"><input id="'+y+'ratio_met" type="text" value=""></td><td class="'+y+'input"><input id="'+y+'ratio_cry" type="text" value=""></td><td class="'+y+'input"><input id="'+y+'ratio_deu" type="text" value=""></td></tr><tr class="alt"><td class="'+y+'label">'+o.IN_EXCH+'</td><td class="'+y+'select"><select id="'+y+'output"><option value="m">'+o.RES_MET+'</option><option value="c">'+o.RES_CRY+'</option><option value="d">'+o.RES_DEU+'</option><option value="mc">'+o.RES_MET+" + "+o.RES_CRY+'</option><option value="md">'+o.RES_MET+" + "+o.RES_DEU+'</option><option value="cd">'+o.RES_CRY+" + "+o.RES_DEU+'</option></select></td><td class="'+y+'input"><input id="'+y+'percent_met" type="text" value=""></td><td class="'+y+'input"><input id="'+y+'percent_cry" type="text" value=""></td><td class="'+y+'input"><input id="'+y+'percent_deu" type="text" value=""></td></tr><tr><td class="'+y+'label" colspan="2">'+o.RESULT+'</td><td class="'+y+'output" id="'+y+'output_met"></td><td class="'+y+'output" id="'+y+'output_cry"></td><td class="'+y+'output" id="'+y+'output_deu"></td></tr><tr><td colspan="5">&nbsp;</td></tr><tr class="alt"><td class="'+y+'label" colspan="5">'+o.PLANET+'</td></tr><tr class="alt"><td class="'+y+'select1row" colspan="5"><select id="'+y+'planet"></select></td></tr><tr><td colspan="5">&nbsp;</td></tr><tr class="alt"><td class="'+y+'label" colspan="5">'+o.MESSAGE+'</td></tr><tr class="alt"><td class="'+y+'textarea" colspan="5"><textarea id="'+y+'message" cols="1" rows="1" readonly="readonly"></textarea></td></tr></tbody></table></div><div id="'+y+'config"><div class="'+y+'config_title">'+o.RAT_LST+'</div><div class="'+y+'config_box"><table cellspacing="0" cellpadding="0"><tbody id="'+y+'ratio_list"><tr><th>#</th><th>'+o.NAME+"</th><th>"+o.RES_MET+"</th><th>"+o.RES_CRY+"</th><th>"+o.RES_DEU+"</th><th>"+o.ACTION+"</th><th>"+o.LEGAL+"</th><th>"+o.DEFAULT+'</th></tr></tbody></table></div><div class="textCenter"><input id="'+y+'config_accept" type="button" value="'+o.ACCEPT+'" class="btn_blue"><input id="'+y+'config_cancel" type="button" value="'+o.CANCEL+'" class="btn_blue"><input id="'+y+'config_default" type="button" value="'+o.RES_DEF+'" class="btn_blue"></div></div></div><div id="'+y+'footer"></div></div>',
/*! [tpl=button] */
MENUBUTTON:'<li><a id="'+y+'menubutton" class="menubutton" href="javascript:void(0)" accesskey="" target="_self"><span class="textlabel">'+o.MENU+"</span></a></li>",
/*! [tpl=ratio_list_limit] */
RATIO_LIST_LIMIT:'<tr><td class="'+y+"label "+y+'pos"></td><td class="'+y+'name_noedit"></td><td class="'+y+'ratio"><input class="'+y+'edit_ratio_met" type="text" /></td><td class="'+y+'ratio"><input class="'+y+'edit_ratio_cry" type="text" /></td><td class="'+y+'ratio"><input class="'+y+'edit_ratio_deu" type="text" /></td><td class="'+y+'action"><a href="javascript:void(0)" class="'+y+'icon_up"></a><a href="javascript:void(0)" class="'+y+'icon_down"></a><a href="javascript:void(0)" class="'+y+'icon_trash disabled"></a></td><td class="'+y+'label">-</td><td class="'+y+'check"><input name="'+y+'def_ratio" type="radio" /></td></tr>',
/*! [tpl=ratio_list_item] */
RATIO_LIST_ITEM:'<tr><td class="'+y+"label "+y+'pos"></td><td class="'+y+'name"><input class="'+y+'edit_ratio_name" type="text" /></td><td class="'+y+'ratio"><input class="'+y+'edit_ratio_met" type="text" /></td><td class="'+y+'ratio"><input class="'+y+'edit_ratio_cry" type="text" /></td><td class="'+y+'ratio"><input class="'+y+'edit_ratio_deu" type="text" /></td><td class="'+y+'action"><a href="javascript:void(0)" class="'+y+'icon_up"></a><a href="javascript:void(0)" class="'+y+'icon_down"></a><a href="javascript:void(0)" class="'+y+'icon_trash"></a></td><td class="'+y+'legal"></td><td class="'+y+'check"><input name="'+y+'def_ratio" type="radio" /></td></tr>',
/*! [tpl=ratio_list_new] */
RATIO_LIST_NEW:'<tr id="'+y+'new_ratio"><td class="undermark '+y+'pos"></td><td class="'+y+'name"><input class="'+y+'edit_ratio_name" type="text" /></td><td class="'+y+'ratio"><input class="'+y+'edit_ratio_met" type="text" /></td><td class="'+y+'ratio"><input class="'+y+'edit_ratio_cry" type="text" /></td><td class="'+y+'ratio"><input class="'+y+'edit_ratio_deu" type="text" /></td><td class="'+y+'action"><a href="javascript:void(0)" class="'+y+'icon_add"></a></td><td class="'+y+'legal"></td><td class="'+y+'label">-</td></tr>',
/*! [/tpl] */
};var u=(function(){var e=l('meta[name="ogame-universe"]').attr("content");
/*! [default_ratios] */
return/^\w+\.ogame\.org$/.test(e)?[3,2,1,2,1,1,3,2,1]:[5,3,1,2,1.5,1,3,2,1];
/*! [/default_ratios] */
})();var s=function(){return(new Date()).getTime()};var a=function(){};var A={DEFAULT_DATA:{
/*! [config=default] */
defAction:"sell",ratioList:[{id:"MAX",ratio:[u[0],u[1],u[2]]},{id:"MIN",ratio:[u[3],u[4],u[5]]},{id:"REG",ratio:[u[6],u[7],u[8]]}],defRatio:"REG",defOutput:"m",millionAbb:"M",millionKey:"m",thousandAbb:"K",thousandKey:"k",abb:false,overUnabb:false,messageTpl:"[b]{?b}{I18N.BUY}{/b}{?s}{I18N.SELL}{/s}:[/b] {?m}[b][color={COLOR.MET}]{m}[/color][/b] ({I18N.RES_MET}){?cd} + {/cd}{/m}{?c}[b][color={COLOR.CRY}]{c}[/color][/b] ({I18N.RES_CRY}){?d} + {/d}{/c}{?d}[b][color={COLOR.DEU}]{d}[/color][/b] ({I18N.RES_DEU}){/d}\n[b]{I18N.IN_EXCH}:[/b] {?M}[b][color={COLOR.MET}]{M}[/color][/b] ({I18N.RES_MET}){?CD} + {/CD}{/M}{?C}[b][color={COLOR.CRY}]{C}[/color][/b] ({I18N.RES_CRY}){?D} + {/D}{/C}{?D}[b][color={COLOR.DEU}]{D}[/color][/b] ({I18N.RES_DEU}){/D}\n\n[b]* {I18N.RATIO}:[/b] {rm}:{rc}:{rd}{?w}\n[b]* {I18N.WHERE}:[/b] {wg}:{ws}:{wp} ({wt}){/w}\n\n[b][url={SCRIPT.HOME_URL}]{SCRIPT.NAME}[/url][/b]"
/*! [/config] */
},getRatio:function(D){var F=this.data.ratioList[D],G=F.id+"",e,E=F.ratio.slice(0);if("name" in F){e=F.name+""}else{e=o[G]}return{id:G,ratio:E,name:e,val:G+":"+E[0]+":"+E[1]+":"+E[2],met:E[0],cry:E[1],deu:E[2]}},getRatioById:function(E){var e,D=this.data.ratioList;for(e in D){if(D[e].id==E){return this.getRatio(e)}}return null},save:function(e){if(arguments.length>0){this.set(e)}k.localStorage.setItem(y+"config",JSON.stringify(this.data));return this},load:function(){var e=k.localStorage.getItem(y+"config");if(e==null){this.data=this.DEFAULT_DATA}else{this.data=JSON.parse(e)}return this},remove:function(){k.localStorage.removeItem(y+"config");this.data=this.DEFAULT_DATA}};var q={formatI:function(G,E){var F,e=(arguments.length>1&&E);if(e&&G==""){return""}if(typeof(G)=="string"){F=("0"+G+"").replace(new RegExp(A.data.thousandKey+"$","i"),"000").replace(new RegExp(A.data.millionKey+"$","i"),"000000").replace(/\D/g,"").replace(/^0+(\d)/,"$1")}else{F=G.toFixed()+""}var D=/(\d+)(\d{3})/;while(D.test(F)){F=F.replace(D,"$1"+o.THO_SEP+"$2")}if(!e&&A.data.abb){return F.replace(/\D000\D000$/,A.data.millionAbb).replace(/\D(\d*[1-9]+)0*\D000$/,o.DEC_SEP+"$1"+A.data.millionAbb).replace(/\D000$/,A.data.thousandAbb)}return F},formatF:function(J,H){var I,e,G,E,D=(arguments.length>1&&H);if(D&&J==""){return""}if(typeof(J)=="string"){I=("0"+J+"").replace(/[\.\,]$/,o.DEC_SEP).replace(new RegExp("[^0-9\\"+o.DEC_SEP+"]","g"),"").replace(/^0+(\d)/,"$1")}else{I=(J+"").replace(".",o.DEC_SEP)}e=I.split(o.DEC_SEP);G=e[0];E=e.length>1?o.DEC_SEP+e[1]:"";if(I[I.length-1]==o.DEC_SEP&&D){E=o.DEC_SEP}var F=/(\d+)(\d{3})/;while(F.test(G)){G=G.replace(F,"$1"+o.THO_SEP+"$2")}return G+E},parseI:function(D){var e=q.parseF(D);if(new RegExp(A.data.thousandAbb+"$","i").test(D)){e=e*1000}else{if(new RegExp(A.data.millionAbb+"$","i").test(D)){e=e*1000000}}return Math.round(e)},parseF:function(e){return parseFloat(e.replaceAll(o.THO_SEP,"").replace(o.DEC_SEP,".").replace(/[^\d\.]/g,""))}};var B=function(){if(arguments.length<1){this.setLimits()}else{if(arguments.length<2){this.setLimits(arguments[0])}else{this.setLimits(arguments[0],arguments[1])}}};B.prototype={limits:[],isLegal:function(){var E;if(arguments.length==1){E=arguments[0]}else{E=[arguments[0],arguments[1],arguments[2]]}var D=E[0]/E[1],e=0;if(D<this.limits[e++]||D>this.limits[e++]){return false}D=E[0]/E[2];if(D<this.limits[e++]||D>this.limits[e++]){return false}D=E[1]/E[2];if(D<this.limits[e++]||D>this.limits[e++]){return false}return true},setLimits:function(F,E){if(arguments.length<2){var J,I,G,H=A.data.ratioList;if(arguments.length>0){H=F}for(G in H){if(H[G].id=="MAX"){J=H[G].ratio}else{if(H[G].id=="MIN"){I=H[G].ratio}}}return this.setLimits(J,I)}this.limits=[];var D=F[0]/F[1],e=E[0]/E[1];this.limits.push(Math.min(D,e));this.limits.push(Math.max(D,e));D=F[0]/F[2];e=E[0]/E[2];this.limits.push(Math.min(D,e));this.limits.push(Math.max(D,e));D=F[1]/F[2];e=E[1]/E[2];this.limits.push(Math.min(D,e));this.limits.push(Math.max(D,e));return this}};var t,r;var b=function(G,H,F,J,K,I,D,E,e){return{met:Math.round(((G+(H/K)*J+(F/I)*J)/100)*D),cry:Math.round((((G/J)*K+H+(F/I)*K)/100)*E),deu:Math.round((((G/J)*I+(H/K)*I+F)/100)*e)}};var x={parseIf:function(I,J,e){var K="{?"+J+"}",F="{/"+J+"}";if(e){return I.split(K).join("").split(F).join("")}var H,G,D,E=I;while((H=E.indexOf(K))>=0&&(G=E.indexOf(F))>=0&&H<G){E=E.split(K);for(H=1;H<E.length;H++){D=E[H].split(F);if(D.length>1){D.shift();E[H]=F+D.shift()+D.join(F)}}E=E.join(K).split(K+F).join("")}return E},parseIfs:function(H,L){var G=H+"",F=H+"",N=/\{\?(\!?\w)+\}/,J,M,K,E,D;while(N.test(G)){J=(N.exec(G)+"").replace(/\}.*$/,"").replace(/^.*\{/,"");G=G.split("{"+J+"}").join("");try{J=J.replace(/[^\w\!]/g,"");if((D=J[K=0])=="!"){M=!L[++K]}else{M=L[D]}E=J.length-1;M=L[J[K]];while(K<E){if((D=J[++K])=="!"){M=(M||!L[++K])}else{M=(M||L[D])}}F=this.parseIf(F,J,M)}catch(I){alert(I)}}return F},make:function(J,E,D,I,e){var G,H=/[1-9]/,F=this.parseIfs(A.data.messageTpl,{b:(J=="buy"),s:(J=="sell"),m:H.test(E.met),c:H.test(E.cry),d:H.test(E.deu),M:H.test(D.met),C:H.test(D.cry),D:H.test(D.deu),w:e.use});F=F.replaceMap({"{m}":E.met,"{c}":E.cry,"{d}":E.deu,"{M}":D.met,"{C}":D.cry,"{D}":D.deu,"{rm}":I.met,"{rc}":I.cry,"{rd}":I.deu,"{wg}":e.galaxy,"{ws}":e.system,"{wp}":e.planet,"{wt}":e.use?"{I18N."+(e.type+"").toUpperCase()+"}":0});for(G in o){F=F.replaceAll("{I18N."+G+"}",o[G])}for(G in p){F=F.replaceAll("{SCRIPT."+G+"}",p[G])}for(G in n){F=F.replaceAll("{COLOR."+G+"}",n[G])}return F}};var v=function(D,e){this.jqo=D;if(arguments.length>1){this.set(e)}};v.prototype={set:function(e){this.jqo.val(e);return this},disable:function(){this.jqo.attr("disabled","disabled").prop("disabled",true);return this},enable:function(){this.jqo.prop("disabled",false).removeAttr("disabled");return this},isDisabled:function(){return(this.jqo.attr("disabled")=="disabled")}};var j=function(I,H,G,F){var J=this,e=(this.jqo=I),E,D=G;this.allow0=true;this.focused=false;this.onChange=a;this.clearOnFocus=F;D=G.substring(0,1).toUpperCase();if(this.typePercent=(D=="P")){D="F"}this.formatFunc=q["format"+D];this.parseFunc=q["parse"+D];if(arguments.length>4){if(arguments.length>5){this.allow0=arguments[4];this.onChange=arguments[5]}else{if(typeof(arguments[4])=="function"){this.onChange=arguments[4]}else{this.allow0=(arguments[4]&&true)}}}this.set(H);E=function(){var O=J.jqo,M=O.val(),N=O.caret(),K=M.length,P=K-N.start,L=K-N.end;M=J.formatFunc(O.val(),true);K=M.length;P=Math.max(Math.min(K-P,K),0);L=Math.max(Math.min(K-L,K),0);num=(M=="")?0:J.parseFunc(M);if(J.allow0||num>0){J.set(M,true).onChange(J)}O.caret(P,L)};e.keyup(function(K){if(!(/^9|16$/.test(K.which+""))){E()}}).change(E).blur(function(){J.set(J.num);J.focused=false}).focus(function(){J.focused=true;var M=l(this);if(J.clearOnFocus||J.num==0){M.val("")}else{var L=M.caret(),K=M.val().length;M.val(J.formatFunc(J.num,true));if(L.end==K){if(L.start==K){L.start=(--L.end)}else{L.end--}}K=M.val().length;M.caret(Math.min(Math.max(0,L.start),K),Math.min(Math.max(0,L.end),K))}}).mouseenter(function(){if(A.data.overUnabb&&!(J.typePercent||J.focused||J.clearOnFocus)){var K=J.jqo;K.val(J.formatFunc(J.num,true));if(K.val()==""){K.val(0)}}}).mouseleave(function(){if(A.data.overUnabb&&!(J.typePercent||J.focused||J.clearOnFocus)){J.jqo.val(J.txt)}})};j.prototype=l.extend(true,{},v.prototype,{set:function(F,E){var e,D=(arguments.length>1&&E);if(typeof(F)=="string"){e=(F+"").replace(/\%$/,"");this.num=(e=="")?0:this.parseFunc(e);this.txt=this.formatFunc(this.num)+(this.typePercent?"%":"")}else{this.num=F;this.txt=(e=this.formatFunc(F))+(this.typePercent?"%":"")}this.jqo.val(D?e:this.txt);return this}});PlanetSelect=function(G,E){var H=this,e=(this.jqo=G);this.onChange=E;e.change(function(){H.set().onChange()});l('<option value="">-</option>').appendTo(e);var F=l('meta[name="ogame-planet-coordinates"]').attr("content").replace(/[^0-9\:]/g,"");var D=l('meta[name="ogame-planet-type"]').attr("content").toLowerCase().trim();l.each(l("#planetList").children("div").get(),function(I,J){var K=l(J),L=K.find(".planet-koords");if(L.get().length==0){return}L=L.text().replace(/[^0-9\:]/g,"");option=l('<option value="planet:'+L+'">['+L+"] "+K.find(".planet-name").text().trim()+"</option>").appendTo(e);if(L==F&&D=="planet"){option.addClass(y+"highlight").html(option.html()+" &laquo; "+o.CUR_PLA)}if(K.find(".moonlink").get().length>0){option=l('<option value="moon:'+L+'">['+L+"] ("+o.MOON+")</option>").appendTo(e).addClass(y+"moon");if(L==F&&D=="moon"){option.addClass(y+"highlight").html(option.html()+" &laquo; "+o.CUR_PLA)}}})};PlanetSelect.prototype={use:false,type:0,galaxy:0,system:0,planet:0,set:function(e){var D=((arguments.length>0)?e:this.jqo.val()).split(":");if(D.length<4){this.use=false}else{this.use=true;this.type=D.shift();this.galaxy=D.shift();this.system=D.shift();this.planet=D.shift()}return this}};var w=function(F,I,G){var D,e,H=this,E;if(arguments.length>2){this.isNew=false;this.name=("name" in G)?G.name:(G.id=="MAX")?o.MAX:(G.id=="MIN")?o.MIN:o.REG;this.id=G.id;E=G.ratio}else{this.isNew=true;this.name="*"+o.NEW;E=A.getRatioById(A.data.defRatio).ratio}this.list=F;if(this.isLimit=/^MIN|MAX$/.test(this.id)){this.jqo=l(f.RATIO_LIST_LIMIT).appendTo(F.jqo);this.jqo.find("."+y+"name_noedit").text(this.name)}else{this.jqo=l(this.isNew?f.RATIO_LIST_NEW:f.RATIO_LIST_ITEM).appendTo(F.jqo);this.nameInput=this.jqo.find("."+y+"edit_ratio_name");this.nameInput.change(function(){H.name=H.nameInput.val().trim()}).keyup(function(){H.nameInput.change()}).val(this.name)}this.posLabel=this.jqo.find("."+y+"pos");this.setPos(I);e=["met","cry","deu"];for(D in e){this[e[D]+"Input"]=new j(this.jqo.find("."+y+"edit_ratio_"+e[D]),E[D],"f",true,false,function(){H.list.onChange()})}this.addButton=this.jqo.find("."+y+"icon_add").click(function(){var K=H.list,J=new w(K,H.pos,H.getInfo());J.disableDown().jqo.after(H.jqo);K.list[H.pos]=J;K.list[H.pos-1].enableDown();H.nameInput.val(H.name="*"+o.NEW);H.setPos(++H.pos)});this.upButton=this.jqo.find("."+y+"icon_up").click(function(){H.move(true)});this.upDisabled=false;this.downButton=this.jqo.find("."+y+"icon_down").click(function(){H.move(false)});this.downDisabled=false;this.trashButton=this.jqo.find("."+y+"icon_trash");if(this.isLimit){this.trashButton.addClass("disabled")}else{this.trashButton.click(function(){H.remove()})}this.radio=this.jqo.find('input[name="'+y+'def_ratio"]').click(function(){H.list.defRatio=H.id});if(F.defRatio==this.id){this.radio.click()}this.legal=this.jqo.find("."+y+"legal")};w.prototype={getInfo:function(){var D=this,e={id:D.isNew?s():D.id,ratio:[D.metInput.num,D.cryInput.num,D.deuInput.num]};if(!D.isLimit){e.name=D.name}return e},move:function(D){var E,e;if(D){if(this.upDisabled){return this}E=this.list.list[this.pos-1];this.jqo.after(E.jqo)}else{if(this.downDisabled){return this}E=this.list.list[this.pos+1];E.jqo.after(this.jqo)}e=this.pos;this.setPos(E.pos);E.setPos(e);e=E.upDisabled;if(this.upDisabled){E.disableUp()}else{E.enableUp()}if(e){this.disableUp()}else{this.enableUp()}e=E.downDisabled;if(this.downDisabled){E.disableDown()}else{E.enableDown()}if(e){this.disableDown()}else{this.enableDown()}this.list.sortList()},remove:function(){var E,e=[],F=this.list.list,D=this.list.newItem;this.jqo.remove();F.splice(this.pos,1);for(E=0;E<F.length;E++){e[E]=(F[E].setPos(E))}this.list.list=e;if(this.list.defRatio==this.id){e[0].radio.click()}if(this.downDisabled){e[e.length-1].disableDown()}if(this.upDisabled){e[0].disableUp()}D.setPos(D.pos-1)},enableUp:function(){this.upDisabled=false;this.upButton.removeClass("disabled");return this},enableDown:function(){this.downDisabled=false;this.downButton.removeClass("disabled");return this},disableUp:function(){this.upDisabled=true;this.upButton.addClass("disabled");return this},disableDown:function(){this.downDisabled=true;this.downButton.addClass("disabled");return this},setLegal:function(e){if(e){this.legal.text(o.YES).addClass("undermark").removeClass("overmark")}else{this.legal.text(o.NO).addClass("overmark").removeClass("undermark")}return this},setPos:function(e){if(e%2==0){this.jqo.addClass("alt")}else{this.jqo.removeClass("alt")}this.pos=e;this.posLabel.html(this.isNew?"+":e+1);return this}};var i={list:[],limits:[],clear:function(){for(var D in this.list){this.list[D].jqo.remove()}this.list=(this.limits=[]);try{this.newItem.jqo.remove()}catch(E){}},sortList:function(){this.list.sort(function(D,e){return D.pos-e.pos})},build:function(){var D,E;this.clear();this.defRatio=A.data.defRatio;for(D=0;D<A.data.ratioList.length;D++){E=new w(this,D,A.data.ratioList[D]);this.list[D]=E;if(E.isLimit){this.limits[this.limits.length]=E}}var e=this.list.length;this.newItem=new w(this,e);this.list[0].disableUp();this.list[e-1].disableDown();this.onChange()},updateData:function(){A.data.ratioList=[];for(var e in this.list){A.data.ratioList[e]=this.list[e].getInfo()}A.data.defRatio=this.defRatio},onChangeItem:function(e){if(!e.isLimit){e.setLegal(r.isLegal(e.getInfo().ratio))}},onChange:function(){r.setLimits(this.limits[0].getInfo().ratio,this.limits[1].getInfo().ratio);for(var e=0;e<this.list.length;e++){this.onChangeItem(this.list[e])}this.onChangeItem(this.newItem)},init:function(e){this.jqo=e;this.build()}};var h=({addCss:function(E){var D=C.createElement("style");D.setAttribute("type","text/css");if(D.styleSheet){D.styleSheet.cssText=E}else{D.appendChild(C.createTextNode(E))}var e=C.getElementsByTagName("head")[0];e.appendChild(D);return this},menuButton:null,menuButtonAction:function(){this.menuButtonAction=function(){};this.makeWindow()},makeMenuButton:function(){var e=this;this.menuButton=l(f.MENUBUTTON).appendTo(l("#menuTableTools")).find("#"+y+"menubutton").click(function(){e.menuButtonAction()});return this},window:null,ogameHide:null,isHidden:true,show:function(){this.isHidden=false;this.ogameHide.hide();this.window.show();return this},hide:function(){this.isHidden=true;this.window.hide();this.ogameHide.show();return this},toggle:function(){if(this.isHidden){return this.show()}return this.hide()},makePlanetSelect:function(){var e=this;this.planet=new PlanetSelect(this.window.find("#"+y+"planet"),function(){e.onChange()});return this},makeActionSelect:function(){var e=this;this.actionJqo=this.window.find("#"+y+"action").change(function(){e.action=l(this).val();e.onChange()}).val(this.action=A.data.defAction);return this},makeResourceInput:function(e,D){var E=this;E["input"+e.capitalize()]=new j(this.window.find("#"+y+"input_"+e),D,"i",false,true,function(){E.checkOutputSelect().onChange()});return this},makeRatioSelect:function(){var e=this;this.ratioSelectJqo=this.window.find("#"+y+"ratio").change(function(){var D=l(this).val().split(":");if(D.length>3){l(this).val("");e.ratioMet.set(parseFloat(D[1]));e.ratioCry.set(parseFloat(D[2]));e.ratioDeu.set(parseFloat(D[3]));e.checkRatio().onChange()}});return this.updateRatioSelect()},updateRatioSelect:function(){var D,e=this.ratioSelectJqo.html("").append(l('<option value="">-</option>'));for(D in A.data.ratioList){ratio=A.getRatio(D);e.append(l('<option value="'+ratio.val+'">'+q.formatF(ratio.met)+":"+q.formatF(ratio.cry)+":"+q.formatF(ratio.deu)+" ("+ratio.name+")</option>"))}return this},makeRatioInput:function(e,D){var E=this;E["ratio"+e.capitalize()]=new j(this.window.find("#"+y+"ratio_"+e),D,"f",true,false,function(){E.checkRatio().onChange()});return this},checkRatio:function(){if(t.isLegal(this.ratioMet.num,this.ratioCry.num,this.ratioDeu.num)){this.ratioIllegal.hide()}else{this.ratioIllegal.show()}return this},makePercentInput:function(e){var E=this,D="percent"+e.capitalize();E[D]=new j(this.window.find("#"+y+"percent_"+e),0,"p",false,true,function(H){if(H.num>100){H.set(100,true)}var F="percentMet",G;if(/Met|Cry/.test(D)&&(!E.percentDeu.isDisabled())){F="percentDeu"}else{if(/Met|Deu/.test(D)&&(!E.percentCry.isDisabled())){F="percentCry"}}G=parseFloat((100-H.num).toFixed((H.num+"").split(".").pop().length));E[F].set(G);E.onChange()});return this},checkOutputSelect:function(){var H=this.outputJqo.val(),F=(this.inputMet.num>0),D=(this.inputCry.num>0),I=(this.inputDeu.num>0),G=/m/.test(H),E=/c/.test(H),e=/d/.test(H);if(!F&&!D&&I&&!G&&!E&&e){this.changeOutputSelect("mc")}else{if(!F&&D&&!I&&!G&&E&&!e){this.changeOutputSelect("md")}else{if(F&&!D&&!I&&G&&!E&&!e){this.changeOutputSelect("cd")}else{if((!F&&D&&I)||G&&((D&&E)||(I&&e))){this.changeOutputSelect("m")}else{if((F&&!D&&I)||E&&((F&&G)||(I&&e))){this.changeOutputSelect("c")}else{if((F&&D&&!I)||e&&((F&&G)||(D&&E))){this.changeOutputSelect("d")}}}}}}return this},changeOutputSelect:function(e){this.outputJqo.val(e);m=this.percentMet.disable().set(0),c=this.percentCry.disable().set(0),d=this.percentDeu.disable().set(0);if(e=="m"){m.set(100)}else{if(e=="c"){c.set(100)}else{if(e=="d"){d.set(100)}else{if(e=="mc"){m.enable().set(50);c.enable().set(50)}else{if(e=="md"){m.enable().set(50);d.enable().set(50)}else{c.enable().set(50);d.enable().set(50)}}}}}return this},makeOutputSelect:function(){var e=this;this.outputJqo=this.window.find("#"+y+"output").change(function(){e.changeOutputSelect(l(this).val());e.onChange()});return this},makeWindow:function(){A.load();t=new B();r=new B();var E=this,e,D=A.getRatioById(A.data.defRatio);this.ogameHide=l("#inhalt").after(e=(this.window=l(f.WINDOW).hide()));this.addCss(f.CSS).show();this.ratioIllegal=e.find("#"+y+"ratio_illegal").hide();this.outputMessage=e.find("#"+y+"message").click(function(){l(this).select()});this.outputMet=e.find("#"+y+"output_met").text(0);this.outputCry=e.find("#"+y+"output_cry").text(0);this.outputDeu=e.find("#"+y+"output_deu").text(0);e.find("#"+y+"close").click(function(){E.hide()});this.makeActionSelect().makeResourceInput("met",0).makeResourceInput("cry",0).makeResourceInput("deu",0).makeRatioSelect().makeRatioInput("met",D.met).makeRatioInput("cry",D.cry).makeRatioInput("deu",D.deu).makeOutputSelect().makePercentInput("met").makePercentInput("cry").makePercentInput("deu").changeOutputSelect(A.data.defOutput).makePlanetSelect().checkRatio();this.menuButtonAction=function(){E.toggle()};e.find("#"+y+"config_but").click(function(){e.toggleClass("config").toggleClass("calc")});i.init(e.find("#"+y+"ratio_list"));var E=this;e.find("#"+y+"config_accept").click(function(){i.updateData();A.save();t.setLimits();E.updateRatioSelect().checkRatio();i.build();e.toggleClass("config").toggleClass("calc")});e.find("#"+y+"config_cancel").click(function(){i.build();r.setLimits();e.toggleClass("config").toggleClass("calc")});e.find("#"+y+"config_default").click(function(){A.remove();t.setLimits();r.setLimits();E.updateRatioSelect().checkRatio();i.build();e.toggleClass("config").toggleClass("calc")});return this},onChange:function(){var e=b(this.inputMet.num,this.inputCry.num,this.inputDeu.num,this.ratioMet.num,this.ratioCry.num,this.ratioDeu.num,this.percentMet.num,this.percentCry.num,this.percentDeu.num);this.outputMet.text(q.formatI(e.met));this.outputCry.text(q.formatI(e.cry));this.outputDeu.text(q.formatI(e.deu));this.outputMessage.text(x.make(this.action,{met:this.inputMet.txt,cry:this.inputCry.txt,deu:this.inputDeu.txt,},{met:this.outputMet.text(),cry:this.outputCry.text(),deu:this.outputDeu.text(),},{met:this.ratioMet.txt,cry:this.ratioCry.txt,deu:this.ratioDeu.txt,},this.planet));return this},init:function(){return this.makeMenuButton()}}).init()})();
